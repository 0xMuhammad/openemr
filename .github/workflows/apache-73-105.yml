name: PHP 7.3 - Apache - MariaDB 10.5

on:
    push:
        branches: [ master ]
    pull_request:
        branches: [ master ]

jobs:
    build:
        runs-on: ubuntu-20.04
        name: Build and test
        env:
          DOCKER_DIR: apache_73_105
          OPENEMR_DIR: /var/www/localhost/htdocs/openemr
          CHROMIUM_INSTALL: "apk update; apk add --no-cache chromium chromium-chromedriver; export PANTHER_CHROME_DRIVER_BINARY=/usr/lib/chromium/chromedriver"
        steps:
            - uses: actions/checkout@v2

            - name: Install PHP
              uses: shivammathur/setup-php@v2
              with:
                php-version: '7.4'

            - name: Report PHP Version
              run: php -v

            - name: Install npm package
              uses: actions/setup-node@v1
              with:
                node-version: '12'

            - name: Dockers environment start
              run: |
                source ci/ciLibrary.source
                dockers_env_start

            - name: Main build
              run: |
                source ci/ciLibrary.source
                composer_github_auth
                main_build

            - name: CCDA build
              run: |
                source ci/ciLibrary.source
                ccda_build

            - name: Install and configure
              run: |
                source ci/ciLibrary.source
                install_configure

            - name: Unit testing
              run: |
                source ci/ciLibrary.source
                build_test_unit

            - name: E2e testing
              run: |
                source ci/ciLibrary.source
                build_test_e2e

            - name: Api testing
              run: |
                source ci/ciLibrary.source
                build_test_api

            - name: Fixtures testing
              run: |
                source ci/ciLibrary.source
                build_test_fixtures

            - name: Services testing
              run: |
                source ci/ciLibrary.source
                build_test_services

            - name: Validators testing
              run: |
                source ci/ciLibrary.source
                build_test_validators

            - name: Controllers testing
              run: |
                source ci/ciLibrary.source
                build_test_controllers

            - name: Common testing
              run: |
                source ci/ciLibrary.source
                build_test_common
